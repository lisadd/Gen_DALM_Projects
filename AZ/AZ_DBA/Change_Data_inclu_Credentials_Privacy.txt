/// The following samples demonstrate how to manage credentials for a linked service in Azure Data Factory/Synapse using Bicep, CLI, and SDK.


////1. Bicep (Infrastructure as Code)
In Bicep, you define the desired state of the linked service. To manage credentials securely, you should store the sensitive information (like account keys or passwords) in Azure Key Vault and reference it in the Bicep file. 

This Bicep example creates an Azure Data Factory linked service for an Azure SQL Database using a secret from an Azure Key Vault.

param factoryName string
param linkedServiceName string
param sqlServerName string
param sqlDbName string
param keyVaultName string
param secretName string
param resourceGroupName string = resourceGroup().name

resource kv 'Microsoft.KeyVault/vaults@2022-07-01' existing = {
  name: keyVaultName
  scope: resourceGroup(resourceGroupName)
}

resource adf 'Microsoft.DataFactory/factories@2018-06-01' existing = {
  name: factoryName
}

resource sqlLinkedService 'Microsoft.DataFactory/factories/linkedservices@2018-06-01' = {
  parent: adf
  name: linkedServiceName
  properties: {
    type: 'AzureSqlDatabase'
    annotations: []
    typeProperties: {
      connectionString: 'Server=tcp:${sqlServerName}.database.windows.net,1433;Initial Catalog=${sqlDbName};Persist Security Info=False;User ID=your_user_name;'
      password: {
        type: 'AzureKeyVaultSecret'
        store: {
          referenceName: kv.name
          type: 'LinkedServiceReference'
        }
        secretName: secretName
      }
    }
    connectVia: {
      referenceName: 'AutoResolveIntegrationRuntime'
      type: 'IntegrationRuntimeReference'
    }
  }
}

NOTE: To update the settings, you would simply update the parameter values in a parameters file (e.g., main.parameters.json) and redeploy the Bicep template using the Azure CLI command:
az deployment group create --resource-group ExampleGroup --template-file <path-to-bicep> --parameters @main.parameters.json. 



//// 2. Azure CLI
The Azure CLI provides commands to create and update linked services. The az datafactory linked-service create or update command accepts a JSON file containing the linked service definition. 

To update a linked service using CLI:
Create a JSON file (sqlLinkedService.json) with the updated connection details. Store secrets in Key Vault and use a managed identity or service principal for authentication when possible.

{
  "properties": {
    "type": "AzureSqlDatabase",
    "typeProperties": {
      "connectionString": "Server=tcp:<your_server>.database.windows.net,1433;Initial Catalog=<your_database>;Persist Security Info=False;User ID=<your_user_name>;",
      "password": {
        "type": "AzureKeyVaultSecret",
        "store": {
          "referenceName": "<your_key_vault_linked_service_name>",
          "type": "LinkedServiceReference"
        },
        "secretName": "<your_secret_name>"
      }
    },
    "connectVia": {
      "referenceName": "AutoResolveIntegrationRuntime",
      "type": "IntegrationRuntimeReference"
    }
  }
}


2. Execute the update command, providing the JSON file:

az datafactory linked-service update --factory-name MyFactory --linked-service-name MySqlLinkedService --resource-group MyResourceGroup --properties "@sqlLinkedService.json"




/// 3. SDK (Python Example)
The Azure SDK allows programmatic management of resources. The following Python example demonstrates how to update a linked service using the azure-mgmt-datafactory library. This assumes you have already authenticated using AzureIdentity and have the required client objects. 


from azure.identity import DefaultAzureCredential
from azure.mgmt.datafactory import DataFactoryManagementClient
from azure.mgmt.datafactory.models import LinkedService, AzureSqlDatabaseLinkedService, AzureKeyVaultSecretReference, LinkedServiceReference

# --- Configuration ---
SUBSCRIPTION_ID = "YOUR_SUBSCRIPTION_ID"
RESOURCE_GROUP_NAME = "YOUR_RESOURCE_GROUP_NAME"
FACTORY_NAME = "YOUR_FACTORY_NAME"
LINKED_SERVICE_NAME = "YOUR_LINKED_SERVICE_NAME"
KEY_VAULT_LINKED_SERVICE_NAME = "YOUR_KEY_VAULT_LINKED_SERVICE_NAME"
SECRET_NAME = "YOUR_SECRET_NAME"
SQL_SERVER_NAME = "your_server"
SQL_DB_NAME = "your_database"
SQL_USER_NAME = "your_user_name"
# ---------------------

# Authenticate
credential = DefaultAzureCredential()
client = DataFactoryManagementClient(credential, SUBSCRIPTION_ID)

# Define the updated linked service properties
sql_linked_service = AzureSqlDatabaseLinkedService(
    connection_string=f"Server=tcp:{SQL_SERVER_NAME}.database.windows.net,1433;Initial Catalog={SQL_DB_NAME};Persist Security Info=False;User ID={SQL_USER_NAME};",
    password=AzureKeyVaultSecretReference(
        store=LinkedServiceReference(
            reference_name=KEY_VAULT_LINKED_SERVICE_NAME
        ),
        secret_name=SECRET_NAME
    ),
    connect_via=IntegrationRuntimeReference(
        reference_name="AutoResolveIntegrationRuntime"
    )
)

# Update (Create or Update operation is generally idempotent) the linked service
linked_service_resource = client.linked_services.create_or_update(
    RESOURCE_GROUP_NAME,
    FACTORY_NAME,
    LINKED_SERVICE_NAME,
    sql_linked_service
)

print(f"Linked service '{linked_service_resource.name}' updated successfully.")



